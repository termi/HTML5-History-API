/*
 * Copyright 2011-2012, Dmitriy Pakhtinov ( spb.piksel@gmail.com ) and github.com/termi */
;(function(){
var f=null,g=window,h=g.JSON||{},i=Function.prototype.bind||!1,j=i.call(Function.prototype.call,Object.prototype.hasOwnProperty),l=g.history||{},n=g.location,o="pushState"in l,aa=o&&void 0===l.state,p=n.href,q=l.pushState,r=l.replaceState,s=h.parse,t=h.stringify,u=g.sessionStorage,v=(/msie (\d+)/i.exec(navigator.userAgent)||[])[1],ba=(new Date).getTime(),w=!v||8<v?0:1,x=8>v?document.createElement("iframe"):0,y=0,ca=/[^\/]+$/g,A=location.pathname.split("#")[0].split("?")[0],B,C=document.createElement("a"),
D,E,F,G,H,I,J,da=/^[^#]*/,ea=/^#[\/]?(?:\/)?/,fa=/^(?:[a-z]+\:)?\/\//;
B=function(a,c){if(a){if(!o)var b=B(),e=b.e,d=b.i,k=a.charAt(0),a=fa.test(a)?"/"==k?d+a:a:d+"//"+b.h+("/"==k?a:"?"==k?e+a:"#"==k?e+b.f+a:e.replace(ca,"")+a)}else if(a=n.href,!o||c)a=n.protocol+"//"+n.host+(-1!=a.indexOf("#")?"/":A)+a.replace(da,"").replace(ea,"");if(D!==a){C.href=D=a;I=C.port;H=C.host;J=C.pathname;if("http:"===C.protocol&&80==I||"https:"===C.protocol&&443==I)H=C.hostname,I="";J="/"==J.charAt(0)?J:"/"+J;E=J+C.search+C.hash;G=J+C.search;F=G+C.hash}return{a:C.protocol+"//"+H+E,i:C.protocol,
h:H,j:C.hostname||n.hostname,k:I||n.port,e:J,f:C.search,d:C.hash,b:E,c:G,g:F}};
var K=!w&&l||{back:l.back,forward:l.forward,go:l.go,pushState:void 0,replaceState:void 0,emulate:!o,toString:function(){return"[object History]"}},N={state:{get:function(){return x&&x.storage||L()[K.location.href]||f}},length:{get:function(){return l.length}},location:{set:function(a){g.location=a},get:function(){return o?n:M}}},M={assign:function(a){n.assign(o||0!==a.indexOf("#")?a:"#"+B().c+a)},reload:n.reload,replace:function(a){n.replace(o||0!==a.indexOf("#")?a:"#"+B().c+a)},toString:function(){return this.href}};
function O(a,c,b){var e=a,d,k=!1;try{if(Object.defineProperty.ielt8)throw Error;Object.defineProperties(a,c)}catch(z){if(a.__defineGetter__)for(var m in c)j(c,m)&&(a.__defineGetter__(m,c[m].get),c[m].set&&a.__defineSetter__(m,c[m].set));if(b)return!1;k=!0}if(!b&&k&&w){b="StaticClass"+ba+w++;e=["Class "+b];"execVB"in g||execScript("Function execVB(c) ExecuteGlobal(c) End Function","VBScript");"VBCVal"in g||execScript("Function VBCVal(o,r) If IsObject(o) Then Set r=o Else r=o End If End Function","VBScript");
for(d in a)e.push("Public ["+d+"]");j(a,"toString")&&(a.propertyIsEnumerable("toString")||e.push("Public [toString]"),c["(toString)"]={get:function(){return this.toString.call(this)}});for(d in c)if(j(c,d)&&(c[d].get&&(a["get "+d]=c[d].get,e.push("Public [get "+d+"]","Public "+("(toString)"===d?"Default ":"")+"Property Get ["+d+"]","Call VBCVal(me.[get "+d+"].call(me),["+d+"])","End Property")),c[d].set))a["set "+d]=c[d].set,e.push("Public [set "+d+"]","Public Property Let ["+d+"](v)","Call me.[set "+
d+"].call(me,v)","End Property","Public Property Set ["+d+"](v)","Call me.[set "+d+"].call(me,v)","End Property");e.push("End Class","Function "+b+"Factory()","Set "+b+"Factory=New "+b,"End Function");execVB(e.join("\n"));e=g[b+"Factory"]();for(d in a)e[d]=a[d];j(a,"toString")&&(e.toString=a.toString)}return e}function L(a){return u?a?u.setItem("__hitoryapi__",t(a)):s(u.getItem("__hitoryapi__"))||{}:{}}
function P(a,c,b){var e=new Event(2==a?"hashchange":"popstate");e.oldUrl=c||"";e.newUrl=b||"";e.__history_shim__=!0;if(!o&&2!=a&&g.onpopstate)g.onpopstate(e);g.dispatchEvent(e)}var Q;function R(a){p===n.href&&(a.stopImmediatePropagation(),p=0);g.removeEventListener("popstate",R)}var S=g.onpopstate||f,T=g.onhashchange||f,U=0,V=f,ga=B(),ha=/^.*?(#|$)/,W=ga.a;function ia(){if(p&&!(p=0)&&ga.b!==A)clearInterval(V),setTimeout(i.call(P),10)}
function ja(a){if(!a.__history_shim__){var c=B();if(y)return W=c.a,y=0;var b=a.oldURL||W,a=W=a.newURL||c.a,c=b.replace(ha,""),e=a.replace(ha,"");b!=a&&!U&&P(void 0,b,a);p=U=0;c!=e&&P(2,b,a)}}g.addEventListener("hashchange",ja);g.addEventListener("popstate",R);g.addEventListener("popstate",function(){p=0;U=1});K=O(K,w?N:void 0===l.state?{state:N.state,location:N.location}:{location:N.location});
M=O(M,{href:{set:function(a){n.href=a},get:function(){return B().a}},protocol:{set:function(a){n.protocol=a},get:function(){return n.protocol}},host:{set:function(a){n.host=a},get:function(){return n.host}},hostname:{set:function(a){n.hostname=a},get:function(){return n.hostname}},port:{set:function(a){n.port=a},get:function(){return n.port}},pathname:{set:function(a){n.pathname=a},get:function(){return B().e}},search:{set:function(a){n.search=a},get:function(){return B().f}},hash:{set:function(a){var a=
0===a.indexOf("#")?a:"#"+a,c=B();x?a!=c.d&&(K.pushState(f,f,c.c+a),Q({oldURL:c.a})):n.hash="#"+c.c+a},get:function(){return B().d}},origin:{}});w&&execScript("Public history, onhashchange","VBScript");!("onpopstate"in g||O(g,{onhashchange:{get:function(){return T},set:function(a){T=a||f}},onpopstate:{get:function(){return S},set:function(a){(S=a||f)&&!o&&ia()}}},!0))&&!o&&(V=setInterval(function(){g.onpopstate&&ia()},100));Q=ja;
K.pushState=function(a,c,b,e){var d=L(),k=B(),z=k.a,m=b&&B(b);p=0;b=m?m.a:z;e&&d[z]&&delete d[z];if((!o||aa)&&u&&a)d[b]=a,L(d),a=f;q&&r?e?r.call(K,a,c,b):q.call(K,a,c,b):m&&m.b!=k.b&&(y=1,e?n.replace("#/"+m.b):n.hash="/"+m.b)};K.replaceState=function(a,c,b){K.pushState(a,c,b,1)};
if(w){g.history=K;var X=document.cookie.split("_historyAPI="),Y=B().a,Z,$;if(x&&($=function(){var a=B().a;Y!=a&&Q({oldURL:Y,newURL:Y=a})},Z=setInterval($,100),x.src="javascript:true;",x=document.documentElement.firstChild.appendChild(x).contentWindow,K.pushState=function(a,c,b,e,d){var k=x.document;if(b=b&&B(b)){d||clearInterval(Z);if(e)x.lfirst?(history.back(),K.pushState(a,c,b.a,0,1)):(x.storage=a,n.replace("#/"+b.g));else if(b.a!=Y||d)x.lfirst||(x.lfirst=1,K.pushState(x.storage,c,Y,0,1)),a=["<script>",
"lfirst=1;",,"storage="+t(a)+";","<\/script>"],a[2]='parent.location.hash="'+b.g.replace(/"/g,'\\"')+'";',k.open(),k.write(a.join("")),k.close();d||(Y=B().a,Z=setInterval($,100))}else x.storage=a},g.attachEvent("unload",function(){if(x.storage){var a={};a[B().a]=x.storage;document.cookie="_historyAPI="+escape(t(a))}clearInterval(Z)}),1<X.length)){X=unescape(X.pop().split(";").shift());try{x.storage=s(X)[B().a]}catch(ka){}}}else g.history.emulate=!o;
})();
